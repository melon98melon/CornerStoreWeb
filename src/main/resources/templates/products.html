<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">

<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Products</title>
    <link rel="stylesheet" th:href="@{/main.css}">
    <link rel="stylesheet" th:href="@{/navbar.css}">
    <style>
        
        *{box-sizing:border-box}
      
        
        
        h1{
            margin:0 0 14px 0;
            font-size:28px;
            font-weight:600;
        }

        /* Top controls: categories left, search right */
        .controls{
            display:flex;
            gap:var(--gap);
            align-items:flex-start;
            margin-bottom:20px;
            flex-wrap:wrap;
        }

        .categories{
            display:flex;
            gap:8px;
            flex-wrap:wrap;
            align-items:center;
        }
        .category-btn{
            padding:8px 10px;
            border-radius:6px;
            border:1px solid rgba(0,0,0,0.08);
            background:#fff;
            cursor:pointer;
            font-size:14px;
        }
        .category-btn.active{
            background:var(--accent);
            color:#fff;
            background-color: burlywood;
            border-color:var(--accent);
        }

        .search-wrap{
            margin-left:auto;
            flex:1;
            min-width:260px;
        }

        .search{
            display:flex;
            gap:8px;
            background:#fff;
            padding:8px;
            border-radius:8px;
            border:1px solid rgba(0,0,0,0.06);
            align-items:center;
        }

        .search input{
            border:0;
            outline:0;
            flex:1;
            font-size:15px;
            padding:6px;
            background:transparent;
        }

        /* Grid of cards */
        .grid{
            display:grid;
            grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
            gap:18px;
        }

        .card{
            background:var(--card-bg);
            border-radius:10px;
            overflow:hidden;
            box-shadow:0 1px 3px rgba(0,0,0,0.06);
            display:flex;
            flex-direction:column;
            min-height:320px;
        }

        .thumb{
            background:#eee;
            min-height:160px;
            display:flex;
            align-items:center;
            justify-content:center;
        }
        .thumb img{
            max-width:100%;
            height: 150px;
            display:block;
        }

        .card-body{
            padding:12px;
            display:flex;
            flex-direction:column;
            gap:8px;
            flex:1;
        }

        .title-row{
            display:flex;
            align-items:center;
            gap:8px;
            justify-content:space-between;
        }
        .product-name{
            font-weight:600;
            font-size:15px;
            color:#111;
            margin-right:8px;
            white-space:nowrap;
            overflow:hidden;
            text-overflow:ellipsis;
        }
        .price{
            color:var(--muted);
            font-weight:700;
        }

        .actions{
            display:flex;
            gap:8px;
            margin-top:auto;
        }

        .btn{
            flex:1;
            padding:8px 10px;
            border-radius:8px;
            border:1px solid rgba(0,0,0,0.08);
            background:#fff;
            cursor:pointer;
            font-weight:600;
        }
        .btn.buy{
            background:var(--accent);
            color:#fff;
            background-color: var(--green);
            border-color:var(--accent);
        }

        .btn.like{
            display:flex;
            align-items:center;
            justify-content:center;
            gap:6px;
            color:red;
            border-color:rgba(233, 30, 98, 0.329);
            background:linear-gradient(0deg, rgba(233,30,99,0.03), rgba(233,30,99,0.03));
        }

        .no-results{
            padding:40px;
            text-align:center;
            color:var(--muted);
        }

        /* small screens */
        @media (max-width:560px){
            .controls{flex-direction:column; align-items:stretch}
            .search-wrap{margin-left:0}
            .categories{justify-content:flex-start}
        }
    </style>
</head>
<body>
    <div th:replace="fragments/navbar :: navbar"></div>

    <div class="container">
        <h1 id="page-title">Products</h1>

        <div class="controls">
            <div class="categories" id="categories"></div>

            <div class="search-wrap">
                <div class="search" role="search">
                    <input id="search" type="search" placeholder="Search products by name..." aria-label="Search products by name" />
                    <button id="clear-search" title="Clear">✕</button>
                </div>
            </div>
        </div>

        <div id="grid" class="grid" aria-live="polite"></div>
        <div id="no-results" class="no-results" style="display:none">No products found.</div>
    </div>

    
    <script>
    // getting data
    let products = []; 
    let categories = [];

    fetch('/api/products')
        .then(response => response.json())
        .then(data => {
            products = data; // store backend data in variable
            localStorage.setItem('products_cache_v1', JSON.stringify(products)); // cache products
            console.log(products);

            // derive categories AFTER products are loaded
            const categoriesSet = new Set(products.map(p => {
                console.log(p.category.name);
                return p.category.name;
            }));
            categories = ["All", ...categoriesSet];

            // now render
            renderCategories();
            renderGrid();
        })
        .catch(error => console.error("Error fetching products:", error));

    const grid = document.getElementById('grid');
    const categoriesEl = document.getElementById('categories');
    const searchInput = document.getElementById('search');
    const clearBtn = document.getElementById('clear-search');
    const noResults = document.getElementById('no-results');

    let activeCategory = 'All';
    let query = '';

    // persist likes in localStorage
    const likesKey = 'product_likes_v1';
    let likes = JSON.parse(localStorage.getItem(likesKey) || '{}');

    function saveLikes(){
        localStorage.setItem(likesKey, JSON.stringify(likes));
    }

    function makePlaceholderSvg(name, color){
        const initials = name.split(' ').map(s=>s[0]).slice(0,2).join('').toUpperCase();
        const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='600' height='400'>
            <rect width='100%' height='100%' fill='${color}'/>
            <text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-size='64' font-family='sans-serif' fill='#fff'>${initials}</text>
        </svg>`;
        return 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg);
    }

    function renderCategories(){
        categoriesEl.innerHTML = '';
        categories.forEach(cat => {
            console.log(cat);
            const btn = document.createElement('button');
            btn.className = 'category-btn' + (cat===activeCategory ? ' active' : '');
            btn.textContent = cat;
            btn.onclick = () => {
                activeCategory = cat;
                renderCategories();
                renderGrid();
            };
            categoriesEl.appendChild(btn);
        });
    }

    function formatPrice(n){
        return '$' + n.toFixed(2);
    }

    function renderGrid(){
        const filtered = products.filter(p => {
            const matchesCategory = activeCategory === 'All' || p.category.name === activeCategory;
            const matchesQuery = !query || p.name.toLowerCase().includes(query.toLowerCase());
            return matchesCategory && matchesQuery;
        });

        grid.innerHTML = '';
        if(filtered.length === 0){
            noResults.style.display = '';
            return;
        } else {
            noResults.style.display = 'none';
        }

        filtered.forEach(p => {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <div class="thumb">
                    <img src="${p.image}" alt="${p.name}" />
                </div>
                <div class="card-body">
                    <div class="title-row">
                        <div class="product-name" title="${p.name}">${p.name}</div>
                        <div class="price">${formatPrice(p.price)}</div>
                    </div>
                    <div style="color:var(--muted); font-size:13px">${p.category.name}</div>
                    <div class="actions">
                        <button class="btn buy" data-id="${p.id}">Buy</button>
                        <button class="btn like" data-id="${p.id}">${likes[p.id] ? '♥' : '♡'}</button>
                    </div>
                </div>
            `;
            grid.appendChild(card);

            // attach listeners
            const buyBtn = card.querySelector('.btn.buy');
            buyBtn.addEventListener('click', () => {
                const key = 'shopping_cart_v1';
                const cart = JSON.parse(localStorage.getItem(key) || '[]');

                // Find if product already in cart
                const existing = cart.find(item => item.id === p.id);
                if (existing) {
                    existing.quantity = (existing.quantity || 1) + 1;
                } else {
                    cart.push({ id: p.id, name: p.name, price: p.price, quantity: 1 });
                }

                localStorage.setItem(key, JSON.stringify(cart));
                alert('Added "' + p.name + '" to cart — price ' + formatPrice(p.price));
            });

            const likeBtn = card.querySelector('.btn.like');
            likeBtn.addEventListener('click', () => {
                likes[p.id] = !likes[p.id];
                saveLikes();
                likeBtn.textContent = likes[p.id] ? '♥' : '♡';
            });
        });
    }

    // events
    searchInput.addEventListener('input', (e) => {
        query = e.target.value.trim();
        renderGrid();
    });

    clearBtn.addEventListener('click', () => {
        searchInput.value = '';
        query = '';
        renderGrid();
    });

    // initialization now happens after fetch completes
</script>
</body>
</html>